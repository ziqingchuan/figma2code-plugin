# Figma 转 Vue3 代码插件 - 系统设计文档

## 1. 项目概述

### 1.1 项目简介
本项目是一个 Figma 插件，能够将 Figma 设计稿自动转换为 Vue3 代码。插件集成了 Coze 工作流，实现了 HTML 和 CSS 的分离，并通过 AI 使类名和标签语义化，提高代码的可读性和可维护性。

### 1.2 核心特性
- **自动代码生成**：将 Figma 设计节点转换为 HTML/CSS 代码
- **AI 语义化**：集成 Coze 工作流，自动生成语义化的类名和标签
- **实时预览**：提供可视化预览功能
- **样式分离**：CSS 与 HTML 完全分离，生成 Vue3 SFC 格式
- **矢量图形支持**：支持 SVG 矢量图形的嵌入
- **颜色变量支持**：支持 Figma 颜色变量的转换
- **多种布局模式**：支持自动布局（Auto Layout）和绝对定位

### 1.3 技术栈
- **前端框架**：React 19.0
- **构建工具**：Vite + esbuild
- **包管理**：pnpm + Turborepo (Monorepo)
- **样式方案**：Tailwind CSS 4.0
- **语言**：TypeScript 5.8
- **AI 集成**：Coze 工作流 API

## 2. 系统架构

### 2.1 整体架构
项目采用 Monorepo 架构，分为以下几个主要部分：

```
figma-to-code/
├── apps/
│   └── plugin/              # Figma 插件主应用
│       ├── plugin-src/      # 插件后端代码（运行在 Figma 沙箱）
│       └── ui-src/          # 插件 UI 代码（React 应用）
├── packages/
│   ├── plugin-logic/        # 核心转换逻辑（backend）
│   ├── plugin-ui/           # UI 组件库
│   ├── types/               # TypeScript 类型定义
│   ├── tsconfig/            # TypeScript 配置
│   └── eslint-config-custom/# ESLint 配置
```

### 2.2 运行环境
插件运行在两个独立的环境中：

1. **Figma 沙箱环境**（plugin-src/code.ts）
   - 运行在 Figma 的 JavaScript 沙箱中
   - 可以访问 Figma API
   - 无法访问 DOM
   - 负责节点数据获取和处理

2. **UI 环境**（ui-src/）
   - 运行在 iframe 中
   - 可以访问 DOM
   - 无法直接访问 Figma API
   - 负责用户界面展示

两个环境通过 `postMessage` 进行通信。

## 3. 核心模块设计

### 3.1 插件后端模块（Plugin Backend）

#### 3.1.1 主入口（code.ts）
负责插件的初始化和事件监听：

**核心功能**：
- 插件设置管理（用户配置的持久化）
- 选择变化监听（selectionchange）
- 文档变化监听（documentchange）
- UI 消息处理（pluginSettingWillChange, get-selection-json）
- 代码生成模式支持（codegen mode）

**关键流程**：
```
初始化 → 加载用户设置 → 显示 UI → 监听事件 → 触发转换 → 发送结果
```

#### 3.1.2 转换引擎（plugin-logic）

**核心转换流程**：
```
Figma 节点 → JSON 格式 → Alt 节点 → HTML/CSS → AI 优化 → Vue3 代码
```

**主要组件**：

1. **节点转换器（jsonNodeConversion.ts）**
   - 将 Figma 节点导出为 JSON_REST_V1 格式
   - 处理节点层级关系和父子引用
   - 处理颜色变量绑定
   - 处理文本样式段落
   - 优化节点结构（内联 GROUP、转换空 FRAME）

2. **HTML 生成器（htmlMain.ts）**
   - 遍历节点树生成 HTML 结构
   - 收集 CSS 样式到全局集合
   - 生成预览内容
   - 调用 AI 优化流程

3. **样式构建器（htmlDefaultBuilder.ts）**
   - 处理位置样式（position, left, top）
   - 处理尺寸样式（width, height）
   - 处理形状样式（background, border, border-radius）
   - 处理效果样式（shadow, blur, opacity）
   - 处理混合模式（blend-mode）

### 3.2 AI 集成模块

#### 3.2.1 Coze 工作流集成（cozeForTotal.ts）

**功能**：
- 调用 Coze 工作流 API
- 传入解析后的 HTML 节点结构
- 接收 AI 生成的语义化类名映射

**API 配置**：
```typescript
const COZE_API_WORKFLOW = 'https://api.coze.cn/v1/workflow/run'
const COZE_WORKFLOW_ID = '7540216444618588206'
```

**数据流**：
```
HTML 节点数组 → Coze API → AI 处理 → 类名映射表 → 应用到代码
```

#### 3.2.2 HTML 解析与重组

1. **HTML 转 JSON（htmlToJSON.ts）**
   - 解析生成的 HTML 字符串
   - 提取节点结构、样式、SVG 内容
   - 生成类名索引映射
   - 保留父子关系上下文

2. **JSON 转 HTML（jsonToHTML.ts）**
   - 将节点结构重新组装为 HTML
   - 应用 AI 生成的语义化类名
   - 生成 Vue3 SFC 格式（template + style）
   - 格式化输出代码

### 3.3 UI 模块

#### 3.3.1 主应用（App.tsx）

**状态管理**：
```typescript
interface AppState {
  code: string;              // 生成的代码
  selectedFramework: Framework;
  isLoading: boolean;        // 加载状态
  htmlPreview: HTMLPreview;  // 预览内容
  settings: PluginSettings;  // 插件设置
  colors: SolidColorConversion[];
  gradients: LinearGradientConversion[];
  warnings: Warning[];       // 警告信息
}
```

**消息处理**：
- `conversionStart`：开始转换，显示加载状态
- `code`：转换完成，更新代码和预览
- `pluginSettingChanged`：设置变更
- `empty`：清空状态
- `error`：错误处理
- `selection-json`：节点 JSON 数据（调试用）

#### 3.3.2 UI 组件

1. **PluginUI**：主界面容器
2. **Preview**：预览组件，支持缩放和响应式显示
3. **CodePanel**：代码展示面板，支持语法高亮和折叠
4. **Loading**：加载动画组件
5. **CopyButton**：复制按钮组件

## 4. 数据流设计

### 4.1 完整转换流程

```
1. 用户选择 Figma 节点
   ↓
2. 触发 selectionchange 事件
   ↓
3. 调用 run() 函数
   ↓
4. nodesToJSON() - 导出节点为 JSON
   ↓
5. processNodePair() - 递归处理节点
   - 处理节点类型转换
   - 内联 GROUP 节点
   - 计算位置和尺寸
   - 处理颜色变量
   - 处理文本样式
   ↓
6. htmlMain() - 生成 HTML/CSS
   - htmlWidgetGenerator() 遍历节点
   - 根据节点类型调用对应生成器
   - 收集 CSS 到 cssCollection
   ↓
7. parseHTMLToNodes() - 解析 HTML
   - 提取节点结构
   - 分离样式和 SVG
   - 生成类名索引
   ↓
8. cozeGenTotal() - AI 优化
   - 调用 Coze 工作流
   - 获取语义化类名映射
   ↓
9. parseNodesToHTML() - 重组代码
   - 应用语义化类名
   - 生成 Vue3 SFC 格式
   ↓
10. postConversionComplete() - 发送结果
   ↓
11. UI 更新显示
```

### 4.2 消息通信机制

**Backend → UI**：
```typescript
// 发送转换完成消息
figma.ui.postMessage({
  type: "code",
  code: string,
  htmlPreview: HTMLPreview,
  colors: SolidColorConversion[],
  gradients: LinearGradientConversion[],
  settings: PluginSettings,
  warnings: Warning[]
});
```

**UI → Backend**：
```typescript
// 发送设置变更消息
parent.postMessage({
  pluginMessage: {
    type: "pluginSettingWillChange",
    key: string,
    value: any
  }
});
```

## 5. 性能优化

### 5.1 性能监控
项目内置了详细的性能监控机制：

```typescript
// 监控的关键指标
- 节点转换总耗时
- JSON 导出耗时
- 代码生成耗时
- HTML 预览生成耗时
- 颜色处理耗时
- getNodeByIdAsync 调用统计
- getStyledTextSegments 调用统计
- processColorVariables 调用统计
```

### 5.2 优化策略

1. **并行处理**
   - 使用 `Promise.all` 并行处理多个节点
   - 并行处理颜色变量
   - 并行处理文本样式段落

2. **缓存机制**
   - 变量缓存（variableCache）
   - 样式缓存（previousExecutionCache）
   - 节点名称计数器缓存

3. **延迟加载**
   - 代码面板支持折叠，初始只显示 25 行
   - 按需展开完整代码

4. **防抖处理**
   - 使用 `isLoading` 标志防止重复执行
   - 延迟重置加载状态

## 6. 错误处理

### 6.1 错误捕获
```typescript
try {
  await run(settings);
} catch (e) {
  // 捕获错误并发送到 UI
  figma.ui.postMessage({ 
    type: "error", 
    error: error.message 
  });
  // 重置 UI 状态
  figma.ui.postMessage({ 
    type: "conversion-complete", 
    success: false 
  });
}
```

### 6.2 警告系统
```typescript
// 收集警告信息
addWarning("矢量图形不支持");
addWarning("文本颜色不支持BlendMode");

// 随转换结果一起返回
postConversionComplete({
  warnings: [...warnings]
});
```

## 7. 配置管理

### 7.1 插件设置
```typescript
interface PluginSettings {
  framework: "HTML";
  showLayerNames: boolean;        // 显示图层名称
  useOldPluginVersion2025: boolean; // 使用旧版转换
  responsiveRoot: boolean;        // 响应式根节点
  useColorVariables: boolean;     // 使用颜色变量
  embedImages: boolean;           // 嵌入图片
  embedVectors: boolean;          // 嵌入矢量图
  htmlGenerationMode: "html";     // HTML 生成模式
}
```

### 7.2 持久化存储
```typescript
// 保存设置
figma.clientStorage.setAsync("userPluginSettings", userPluginSettings);

// 读取设置
const settings = await figma.clientStorage.getAsync("userPluginSettings");
```

## 8. 扩展性设计

### 8.1 框架支持
虽然当前只支持 HTML，但架构设计支持未来扩展其他框架：
- 类型定义预留了 Framework 类型
- 代码生成器可以根据 framework 参数选择不同的生成策略

### 8.2 AI 模型切换
AI 集成模块设计为可插拔：
- 可以轻松切换不同的 AI 服务
- 支持本地模型和云端模型
- 预留了回退机制（AI 失败时使用人工生成的类名）

## 9. 安全性

### 9.1 网络访问控制
```json
"networkAccess": {
  "allowedDomains": [
    "https://api.coze.cn/v1/workflow/run"
  ]
}
```

### 9.2 数据隐私
- 不收集用户数据
- API Token 硬编码（生产环境应使用环境变量）
- 所有处理在本地完成，仅 AI 优化需要网络请求

## 10. 部署与发布

### 10.1 构建流程
```bash
# 开发模式
pnpm dev

# 生产构建
pnpm build
```

### 10.2 构建产物
```
apps/plugin/dist/
├── code.js          # 插件后端代码
└── index.html       # 插件 UI（内联所有资源）
```

### 10.3 Figma 插件配置
```json
{
  "name": "figma2html",
  "id": "1539124463849863689",
  "main": "apps/plugin/dist/code.js",
  "ui": "apps/plugin/dist/index.html",
  "editorType": ["figma", "dev"],
  "capabilities": ["inspect", "codegen", "vscode"]
}
```

## 11. 未来规划

### 11.1 功能增强
- [ ] 支持更多 CSS 框架（Tailwind、UnoCSS）
- [ ] 支持组件库集成（Element Plus、Ant Design Vue）
- [ ] 支持响应式断点
- [ ] 支持动画和交互导出
- [ ] 支持主题变量导出

### 11.2 性能优化
- [ ] 增量更新机制
- [ ] Web Worker 并行处理
- [ ] 更智能的缓存策略

### 11.3 AI 能力提升
- [ ] 支持更多 AI 模型
- [ ] 组件识别和复用
- [ ] 代码质量评分
- [ ] 自动优化建议
