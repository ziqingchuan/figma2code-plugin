# Figma 转 Vue3 代码插件 - 架构设计文档

## 1. 架构概览

### 1.1 整体架构图

本项目采用分层架构和 Monorepo 管理方式，主要分为以下几层：

```
┌─────────────────────────────────────────────────────────┐
│                    用户界面层 (UI Layer)                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │   Preview    │  │  CodePanel   │  │   Loading    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│                    React Components                      │
└─────────────────────────────────────────────────────────┘
                            ↕ postMessage
┌─────────────────────────────────────────────────────────┐
│                  插件控制层 (Plugin Layer)                │
│  ┌──────────────────────────────────────────────────┐  │
│  │  code.ts - 插件主控制器                            │  │
│  │  - 事件监听 (selection/document change)           │  │
│  │  - 设置管理                                        │  │
│  │  - 消息路由                                        │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                 业务逻辑层 (Logic Layer)                  │
│  ┌──────────────────────────────────────────────────┐  │
│  │  plugin-logic (backend)                          │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐ │  │
│  │  │ 节点转换器  │  │ HTML生成器 │  │ 样式构建器 │ │  │
│  │  └────────────┘  └────────────┘  └────────────┘ │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                  AI 集成层 (AI Layer)                     │
│  ┌──────────────────────────────────────────────────┐  │
│  │  HTML Parser → Coze API → HTML Generator         │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                  数据访问层 (Data Layer)                  │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Figma API                                        │  │
│  │  - exportAsync (JSON_REST_V1)                     │  │
│  │  - getStyledTextSegments                          │  │
│  │  - clientStorage                                  │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 1.2 Monorepo 结构

```
figma-to-code/
├── apps/
│   └── plugin/                    # 主应用
│       ├── plugin-src/            # Figma 沙箱代码
│       │   └── code.ts           # 插件入口
│       └── ui-src/                # UI 代码
│           ├── App.tsx           # 主应用组件
│           ├── main.tsx          # React 入口
│           └── messaging.ts      # 消息通信
├── packages/
│   ├── plugin-logic/              # 核心逻辑包
│   │   └── src/
│   │       ├── altNodes/         # 节点转换
│   │       ├── common/           # 通用工具
│   │       ├── html/             # HTML 生成
│   │       ├── code.ts           # 转换入口
│   │       └── messaging.ts      # 消息定义
│   ├── plugin-ui/                 # UI 组件包
│   │   └── src/
│   │       ├── components/       # React 组件
│   │       └── PluginUI.tsx      # 主 UI 组件
│   ├── types/                     # 类型定义包
│   ├── tsconfig/                  # TS 配置包
│   └── eslint-config-custom/      # ESLint 配置包
└── turbo.json                     # Turborepo 配置
```

## 2. 核心模块架构

### 2.1 节点转换模块 (Node Conversion)

```

┌─────────────────────────────────────────────────────────┐
│              nodesToJSON (节点转换入口)                    │
│  - 导出 Figma 节点为 JSON_REST_V1 格式                    │
│  - 处理 GROUP 到 FRAME 的转换                             │
│  - 处理旋转累积                                           │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│           processNodePair (递归节点处理器)                 │
│  ┌───────────────────────────────────────────────────┐  │
│  │ 1. 节点类型转换                                     │  │
│  │    - 空 FRAME → RECTANGLE                          │  │
│  │    - GROUP → 内联子节点                             │  │
│  │    - SLICE → null (过滤)                           │  │
│  ├───────────────────────────────────────────────────┤  │
│  │ 2. 节点元数据处理                                   │  │
│  │    - 生成唯一名称 (uniqueName)                      │  │
│  │    - 计算累积旋转 (cumulativeRotation)             │  │
│  │    - 设置父节点引用                                 │  │
│  ├───────────────────────────────────────────────────┤  │
│  │ 3. 位置和尺寸计算                                   │  │
│  │    - 从 absoluteBoundingBox 提取                   │  │
│  │    - 考虑旋转角度                                   │  │
│  │    - 相对于父节点计算                               │  │
│  ├───────────────────────────────────────────────────┤  │
│  │ 4. 样式属性处理                                     │  │
│  │    - 颜色变量绑定 (processColorVariables)          │  │
│  │    - 文本样式段落 (getStyledTextSegments)          │  │
│  │    - 描边权重 (individualStrokeWeights)            │  │
│  ├───────────────────────────────────────────────────┤  │
│  │ 5. 布局属性处理                                     │  │
│  │    - 设置默认布局模式                               │  │
│  │    - 处理 Auto Layout 属性                         │  │
│  │    - 调整子节点顺序 (itemReverseZIndex)            │  │
│  ├───────────────────────────────────────────────────┤  │
│  │ 6. 特殊标记                                         │  │
│  │    - canBeFlattened (可展平为 SVG)                 │  │
│  │    - isRelative (需要相对定位)                      │  │
│  │    - colorVariableMappings (颜色变量映射)          │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│                  转换后的节点树                           │
│  - 扁平化的 GROUP 节点                                    │
│  - 带有父子引用的完整节点树                               │
│  - 包含所有必要的样式和布局信息                           │
└─────────────────────────────────────────────────────────┘
```

### 2.2 HTML 生成模块 (HTML Generation)

```
┌─────────────────────────────────────────────────────────┐
│                htmlMain (HTML 生成入口)                   │
│  - 初始化全局状态 (cssCollection)                        │
│  - 调用 htmlWidgetGenerator                              │
│  - 收集生成的 CSS                                         │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│          htmlWidgetGenerator (节点遍历器)                 │
│  - 过滤不可见节点                                         │
│  - 并行处理所有节点                                       │
│  - 调用 convertNode                                      │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│            convertNode (节点类型路由器)                    │
│  ┌───────────────────────────────────────────────────┐  │
│  │ FRAME/INSTANCE/COMPONENT → htmlFrame              │  │
│  │ GROUP → htmlGroup                                 │  │
│  │ TEXT → htmlText                                   │  │
│  │ RECTANGLE/ELLIPSE → htmlContainer                 │  │
│  │ LINE → htmlLine                                   │  │
│  │ SECTION → htmlSection                             │  │
│  │ VECTOR (embedVectors) → htmlWrapSVG               │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│         HtmlDefaultBuilder (样式构建器)                   │
│  ┌───────────────────────────────────────────────────┐  │
│  │ commonPositionStyles()                            │  │
│  │  ├─ size()          - 宽高                         │  │
│  │  ├─ position()      - 定位                         │  │
│  │  ├─ blend()         - 混合模式、透明度、旋转        │  │
│  │  └─ autoLayoutPadding() - 内边距                   │  │
│  ├───────────────────────────────────────────────────┤  │
│  │ commonShapeStyles()                               │  │
│  │  ├─ applyFillsToStyle() - 填充/背景                │  │
│  │  ├─ border()        - 边框                         │  │
│  │  ├─ shadow()        - 阴影                         │  │
│  │  └─ blur()          - 模糊效果                     │  │
│  ├───────────────────────────────────────────────────┤  │
│  │ build()                                           │  │
│  │  - 组装所有样式为 style 属性                        │  │
│  │  - 添加 data 属性                                  │  │
│  │  - 返回完整的 HTML 属性字符串                       │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│                  生成的 HTML 字符串                       │
│  - 内联样式的 HTML 结构                                   │
│  - 嵌入的 SVG 内容                                        │
│  - 保留的图层名称 (data-layer)                           │
└─────────────────────────────────────────────────────────┘
```

### 2.3 AI 优化模块 (AI Optimization)

```
┌─────────────────────────────────────────────────────────┐
│              optimizeOutput (优化入口)                    │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│         parseHTMLToNodes (HTML 解析器)                    │
│  ┌───────────────────────────────────────────────────┐  │
│  │ 输入: HTML 字符串                                   │  │
│  │ 输出:                                              │  │
│  │  - nodes: HtmlNode[]        (节点结构)             │  │
│  │  - svgContentMap: {}        (SVG 内容映射)         │  │
│  │  - styleMap: {}             (样式映射)             │  │
│  │  - classNameMap: {}         (类名映射)             │  │
│  ├───────────────────────────────────────────────────┤  │
│  │ 解析过程:                                          │  │
│  │  1. 逐字符扫描 HTML                                │  │
│  │  2. 识别标签 (div/span/img)                        │  │
│  │  3. 提取属性 (style/src/data-svg-wrapper)         │  │
│  │  4. 提取 SVG 内容                                  │  │
│  │  5. 递归解析子节点                                 │  │
│  │  6. 生成索引映射                                   │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│           cozeGenTotal (Coze 工作流调用)                  │
│  ┌───────────────────────────────────────────────────┐  │
│  │ 输入: HtmlNode[]                                   │  │
│  │ 输出: { [classID]: semanticClassName }            │  │
│  ├───────────────────────────────────────────────────┤  │
│  │ API 调用:                                          │  │
│  │  POST https://api.coze.cn/v1/workflow/run         │  │
│  │  Headers:                                         │  │
│  │    Authorization: Bearer {token}                  │  │
│  │    Content-Type: application/json                 │  │
│  │  Body:                                            │  │
│  │    workflow_id: "7540216444618588206"             │  │
│  │    parameters: { input: HtmlNode[] }              │  │
│  ├───────────────────────────────────────────────────┤  │
│  │ 响应处理:                                          │  │
│  │  1. 解析 JSON 响应                                 │  │
│  │  2. 提取 data.res 字段                             │  │
│  │  3. 返回类名映射表                                 │  │
│  ├───────────────────────────────────────────────────┤  │
│  │ 错误处理:                                          │  │
│  │  - HTTP 错误 → 抛出异常                            │  │
│  │  - 解析失败 → 抛出异常                             │  │
│  │  - 缺少 res 字段 → 抛出异常                        │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│        parseNodesToHTML (HTML 重组器)                     │
│  ┌───────────────────────────────────────────────────┐  │
│  │ 输入:                                              │  │
│  │  - nodes: HtmlNode[]                              │  │
│  │  - svgContentMap: {}                              │  │
│  │  - styleContentMap: {}                            │  │
│  │  - classNameMap: {}  (AI 生成的语义化类名)         │  │
│  ├───────────────────────────────────────────────────┤  │
│  │ 生成过程:                                          │  │
│  │  1. 递归遍历节点树                                 │  │
│  │  2. 应用语义化类名                                 │  │
│  │  3. 插入 SVG 内容                                  │  │
│  │  4. 收集样式到 styleMap                            │  │
│  │  5. 生成 <template> 部分                          │  │
│  │  6. 生成 <style scoped> 部分                      │  │
│  ├───────────────────────────────────────────────────┤  │
│  │ 输出格式 (Vue3 SFC):                               │  │
│  │  <template>                                       │  │
│  │    <div class="semantic-name">...</div>           │  │
│  │  </template>                                      │  │
│  │  <style scoped>                                   │  │
│  │    .semantic-name { ... }                         │  │
│  │  </style>                                         │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

## 3. 数据流架构

### 3.1 主数据流

```
用户选择节点
    ↓
selectionchange 事件
    ↓
run(settings)
    ↓
┌─────────────────────────────────────┐
│ 阶段 1: 节点导出                     │
│ nodesToJSON()                       │
│ - Figma Node → JSON_REST_V1         │
│ - 耗时: ~100-500ms                  │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 阶段 2: 节点处理                     │
│ processNodePair()                   │
│ - JSON → Alt Node                   │
│ - 递归处理所有子节点                 │
│ - 耗时: ~50-200ms                   │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 阶段 3: HTML 生成                    │
│ htmlMain()                          │
│ - Alt Node → HTML/CSS               │
│ - 耗时: ~100-300ms                  │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 阶段 4: HTML 解析                    │
│ parseHTMLToNodes()                  │
│ - HTML → HtmlNode[]                 │
│ - 耗时: ~10-50ms                    │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 阶段 5: AI 优化                      │
│ cozeGenTotal()                      │
│ - HtmlNode[] → 语义化类名            │
│ - 耗时: ~500-2000ms (网络请求)      │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 阶段 6: 代码重组                     │
│ parseNodesToHTML()                  │
│ - HtmlNode[] → Vue3 SFC             │
│ - 耗时: ~10-50ms                    │
└─────────────────────────────────────┘
    ↓
postConversionComplete()
    ↓
UI 更新显示
```

### 3.2 消息通信架构

```
┌─────────────────────────────────────────────────────────┐
│                  Figma 沙箱环境                          │
│  ┌───────────────────────────────────────────────────┐  │
│  │ code.ts                                           │  │
│  │  - 监听 Figma 事件                                 │  │
│  │  - 调用转换逻辑                                    │  │
│  │  - 发送消息到 UI                                   │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                        ↕
            figma.ui.postMessage()
            window.onmessage
                        ↕
┌─────────────────────────────────────────────────────────┐
│                    UI 环境 (iframe)                      │
│  ┌───────────────────────────────────────────────────┐  │
│  │ App.tsx                                           │  │
│  │  - 接收消息                                        │  │
│  │  - 更新状态                                        │  │
│  │  - 渲染 UI                                         │  │
│  │  - 发送消息到沙箱                                  │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

**消息类型**:

Backend → UI:
- `conversionStart`: 开始转换
- `code`: 转换完成（包含代码、预览、颜色等）
- `pluginSettingsChanged`: 设置已更改
- `empty`: 清空状态
- `error`: 错误信息
- `selection-json`: 节点 JSON 数据

UI → Backend:
- `pluginSettingWillChange`: 用户更改设置
- `get-selection-json`: 请求节点 JSON（调试用）

## 4. 性能优化架构

### 4.1 并行处理策略

```
┌─────────────────────────────────────────────────────────┐
│              并行处理点                                   │
├─────────────────────────────────────────────────────────┤
│ 1. 节点导出                                              │
│    Promise.all(nodes.map(node => node.exportAsync()))   │
│                                                          │
│ 2. 颜色变量处理                                          │
│    Promise.all(fills.map(fill => processColorVariables))│
│                                                          │
│ 3. 文本样式段落处理                                      │
│    Promise.all(segments.map(async segment => {...}))    │
│                                                          │
│ 4. 子节点处理                                            │
│    Promise.all(children.map(child => processNodePair))  │
│                                                          │
│ 5. HTML 生成                                             │
│    Promise.all(nodes.map(convertNode))                  │
└─────────────────────────────────────────────────────────┘
```

### 4.2 缓存架构

```
┌─────────────────────────────────────────────────────────┐
│                  缓存层级                                 │
├─────────────────────────────────────────────────────────┤
│ 1. 变量缓存 (variableCache)                              │
│    Map<variableId, colorName>                           │
│    - 避免重复查询变量                                    │
│                                                          │
│ 2. 节点名称计数器 (nodeNameCounters)                     │
│    Map<nodeName, count>                                 │
│    - 生成唯一节点名称                                    │
│                                                          │
│ 3. 样式缓存 (previousExecutionCache)                     │
│    Array<{style, text}>                                 │
│    - 缓存文本样式用于 codegen 模式                       │
│                                                          │
│ 4. CSS 集合 (cssCollection)                              │
│    { [className]: { styles, nodeName, nodeType } }      │
│    - 收集所有 CSS 样式                                   │
│                                                          │
│ 5. 用户设置 (figma.clientStorage)                        │
│    - 持久化用户配置                                      │
└─────────────────────────────────────────────────────────┘
```

## 5. 扩展性架构

### 5.1 插件式架构

```
┌─────────────────────────────────────────────────────────┐
│                  核心接口                                 │
├─────────────────────────────────────────────────────────┤
│ interface Builder {                                     │
│   commonPositionStyles(): this                          │
│   commonShapeStyles(): this                             │
│   build(): string                                       │
│ }                                                        │
│                                                          │
│ interface Converter {                                   │
│   convert(node: SceneNode): Promise<string>             │
│ }                                                        │
│                                                          │
│ interface AIProvider {                                  │
│   optimize(nodes: HtmlNode[]): Promise<ClassNameMap>    │
│ }                                                        │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│                  实现类                                   │
├─────────────────────────────────────────────────────────┤
│ HtmlDefaultBuilder implements Builder                   │
│ HtmlTextBuilder extends HtmlDefaultBuilder              │
│                                                          │
│ CozeAIProvider implements AIProvider                    │
│ LocalAIProvider implements AIProvider (未来)             │
└─────────────────────────────────────────────────────────┘
```

### 5.2 框架扩展架构

```
当前: HTML Only
未来可扩展:

┌─────────────────────────────────────────────────────────┐
│              Framework Adapters                          │
├─────────────────────────────────────────────────────────┤
│ HtmlAdapter (当前)                                       │
│  - htmlMain()                                           │
│  - HtmlDefaultBuilder                                   │
│                                                          │
│ TailwindAdapter (未来)                                   │
│  - tailwindMain()                                       │
│  - TailwindBuilder                                      │
│                                                          │
│ VueComponentAdapter (未来)                               │
│  - vueComponentMain()                                   │
│  - VueComponentBuilder                                  │
└─────────────────────────────────────────────────────────┘
```

## 6. 安全架构

### 6.1 沙箱隔离

```
┌─────────────────────────────────────────────────────────┐
│              Figma 沙箱环境                              │
│  - 无 DOM 访问                                           │
│  - 无网络访问（除白名单）                                │
│  - 有 Figma API 访问                                     │
│  - 运行插件后端代码                                      │
└─────────────────────────────────────────────────────────┘
                        ↕
            受限的 postMessage 通信
                        ↕
┌─────────────────────────────────────────────────────────┐
│                UI 环境 (iframe)                          │
│  - 有 DOM 访问                                           │
│  - 有网络访问（受 CSP 限制）                             │
│  - 无 Figma API 访问                                     │
│  - 运行 React UI 代码                                    │
└─────────────────────────────────────────────────────────┘
```

### 6.2 网络访问控制

```json
{
  "networkAccess": {
    "allowedDomains": [
      "https://api.coze.cn/v1/workflow/run"
    ]
  }
}
```

只允许访问 Coze API，其他网络请求被阻止。

## 7. 部署架构

### 7.1 构建流程

```
┌─────────────────────────────────────────────────────────┐
│                  开发模式                                 │
│  pnpm dev                                               │
│    ↓                                                    │
│  turbo run dev --concurrency 20                         │
│    ↓                                                    │
│  ┌─────────────────┐  ┌─────────────────┐             │
│  │ esbuild watch   │  │ vite dev        │             │
│  │ (plugin-src)    │  │ (ui-src)        │             │
│  └─────────────────┘  └─────────────────┘             │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                  生产构建                                 │
│  pnpm build                                             │
│    ↓                                                    │
│  turbo run build                                        │
│    ↓                                                    │
│  ┌─────────────────┐  ┌─────────────────┐             │
│  │ esbuild bundle  │  │ vite build      │             │
│  │ → code.js       │  │ → index.html    │             │
│  │ (minified)      │  │ (inlined)       │             │
│  └─────────────────┘  └─────────────────┘             │
│           ↓                    ↓                        │
│     apps/plugin/dist/                                   │
│       ├── code.js                                       │
│       └── index.html                                    │
└─────────────────────────────────────────────────────────┘
```

### 7.2 发布流程

```
1. 本地构建
   pnpm build
   
2. 测试插件
   - 在 Figma 中加载 manifest.json
   - 测试核心功能
   
3. 发布到 Figma Community
   - 提交插件审核
   - 等待审核通过
   
4. 版本管理
   - 更新 manifest.json 中的版本号
   - 创建 Git tag
   - 发布 Release Notes
```

## 8. 监控与调试架构

### 8.1 性能监控

```
┌─────────────────────────────────────────────────────────┐
│              性能计数器                                   │
├─────────────────────────────────────────────────────────┤
│ getNodeByIdAsyncTime: number                            │
│ getNodeByIdAsyncCalls: number                           │
│ getStyledTextSegmentsTime: number                       │
│ getStyledTextSegmentsCalls: number                      │
│ processColorVariablesTime: number                       │
│ processColorVariablesCalls: number                      │
│                                                          │
│ 输出格式:                                                │
│ [性能监控] 节点转换耗时: 150ms                           │
│ [性能监控] 代码生成耗时: 200ms                           │
│ [性能监控] getNodeByIdAsync: 50ms (10次, 平均5ms/次)    │
└─────────────────────────────────────────────────────────┘
```

### 8.2 调试工具

```
1. 控制台日志
   - [调试] 前缀的详细日志
   - [性能监控] 前缀的性能数据
   - [警告] 前缀的警告信息

2. 节点 JSON 导出
   - 通过 UI 消息 "get-selection-json"
   - 导出完整的节点数据结构
   - 自动复制到剪贴板

3. 警告系统
   - 收集转换过程中的警告
   - 随结果一起返回到 UI
   - 帮助用户了解不支持的功能
```

## 9. 总结

本架构设计具有以下特点：

1. **模块化**: 清晰的模块划分，职责单一
2. **可扩展**: 支持未来添加新框架和 AI 提供商
3. **高性能**: 并行处理和多级缓存
4. **安全性**: 沙箱隔离和网络访问控制
5. **可维护**: Monorepo 管理，类型安全
6. **可观测**: 完善的性能监控和调试工具
